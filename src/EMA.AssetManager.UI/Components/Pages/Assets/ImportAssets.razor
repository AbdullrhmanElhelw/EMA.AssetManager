@page "/assets/import"
@using EMA.AssetManager.Services.Dtos.Import
@using EMA.AssetManager.Services.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject ExcelImportService ImportService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudText Typo="Typo.h4" Class="mb-4 font-bold" Color="Color.Primary">📤 استيراد الأصول (Excel)</MudText>
    <MudText Typo="Typo.subtitle1" Class="mb-6">إضافة كميات كبيرة من الأصول باستخدام القالب الذكي.</MudText>

    <MudPaper Class="pa-8 d-flex flex-column align-center justify-center dashed-border" Elevation="0">
        <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Large" Color="Color.Primary" Class="mb-4" Style="font-size: 4rem;" />

        <MudText Typo="Typo.h6">ارفع ملف الإكسيل هنا</MudText>

        <InputFile id="fileInput" OnChange="UploadFiles" hidden accept=".xlsx" />

        <MudButton HtmlTag="label"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.FolderOpen"
                   Class="mt-4"
                   for="fileInput">
            اختر ملف (.xlsx)
        </MudButton>
    </MudPaper>

    <div class="mt-4 text-center">
        <MudButton Variant="Variant.Text"
                   StartIcon="@Icons.Material.Filled.Download"
                   Color="Color.Secondary"
                   OnClick="DownloadTemplate">
            تحميل القالب الذكي (Dropdowns)
        </MudButton>
    </div>

    @if (_isProcessing)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-6" />
        <MudText Align="Align.Center" Class="mt-2">جاري المعالجة والتحقق...</MudText>
    }

    @if (_result != null)
    {
        <div class="mt-6">
            @if (_result.SuccessCount > 0)
            {
                <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="mb-2">
                    ✅ تم استيراد <b>@_result.SuccessCount</b> أصل بنجاح!
                </MudAlert>
            }

            @if (_result.Errors != null && _result.Errors.Any())
            {
                <MudExpansionPanels>
                    <MudExpansionPanel Text="@($"يوجد {_result.Errors.Count} ملاحظات/أخطاء (اضغط للتفاصيل)")" IsExpanded="true">
                        <MudList T="string" Dense="true">
                            @foreach (var error in _result.Errors)
                            {
                                <MudListItem Icon="@Icons.Material.Filled.Warning" IconColor="Color.Warning">
                                    @error
                                </MudListItem>
                            }
                        </MudList>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
        </div>
    }
</MudContainer>

@code {
    private bool _isProcessing = false;
    private ImportResultDto? _result;

    // دالة تحميل القالب الذكي
    private async Task DownloadTemplate()
    {
        try
        {
            // انتظر حتى يتم جلب البيانات وتكوين الملف
            var fileBytes = await ImportService.GenerateTemplateAsync();

            var base64 = Convert.ToBase64String(fileBytes);
            // تأكد إن ملف downloadHelper.js موجود ومربوط في App.razor
            await JS.InvokeVoidAsync("saveAsFile", "Smart_Assets_Template.xlsx", base64);

            Snackbar.Add("تم تحميل القالب بنجاح", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"فشل التحميل: {ex.Message}", Severity.Error);
        }
    }

    // دالة رفع ومعالجة الملف
    private async Task UploadFiles(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        _isProcessing = true;
        _result = null;

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.Identity?.Name ?? "System";

            long maxFileSize = 1024 * 1024 * 5; // 5 MB Limit

            using var stream = file.OpenReadStream(maxFileSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            _result = await ImportService.ImportAssetsFromExcelAsync(memoryStream, userId);

            if (_result.SuccessCount == 0 && (_result.Errors == null || !_result.Errors.Any()))
            {
                Snackbar.Add("الملف فارغ أو لا يحتوي على بيانات صحيحة", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"حدث خطأ: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }
}

<style>
    .dashed-border {
        border: 2px dashed #c5a059;
        background-color: #f9fcfb;
        border-radius: 12px;
        transition: all 0.3s;
        cursor: pointer;
    }

        .dashed-border:hover {
            background-color: #eef5f2;
            border-color: #1E3A2F;
        }

    .font-bold {
        font-weight: 800;
    }
</style>
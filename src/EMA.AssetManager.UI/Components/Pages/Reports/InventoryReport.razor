@page "/reports/inventory"
@using EMA.AssetManager.Services.Dtos.Reports
@using EMA.AssetManager.Services.Interfaces
@using EMA.AssetManager.Domain.Entities
@inject IReportService ReportService
@inject ISettingsService SettingsService
@inject IJSRuntime JS

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4 no-print">
        <MudButton StartIcon="@Icons.Material.Filled.ArrowForward" Href="/reports" Variant="Variant.Text">عودة للتقارير</MudButton>
        <MudButton StartIcon="@Icons.Material.Filled.Print" Variant="Variant.Filled" Color="Color.Primary" OnClick="PrintReport">طباعة التقرير</MudButton>
    </div>

    <div id="printableArea" class="pa-8 bg-white report-container">

        <table class="header-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <tr>
                <td style="text-align: right; vertical-align: middle;">
                    <h2 style="margin: 0; color: @_settings.PrimaryColor; font-weight: 800; font-size: 24px;">@_settings.CompanyName</h2>
                    <h3 style="margin: 5px 0 0; font-size: 18px;">@_settings.BranchName</h3>
                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">تاريخ التقرير: @DateTime.Now.ToString("yyyy/MM/dd - HH:mm")</p>
                </td>

                <td style="width: 120px; text-align: left; vertical-align: middle;">
                    @if (string.IsNullOrEmpty(_settings.LogoPath))
                    {
                        <img src="/logo.png" width="100" height="100" style="object-fit: contain;" />
                    }
                    else
                    {
                        <img src="@_settings.LogoPath" width="100" height="100" style="object-fit: contain;" />
                    }
                </td>
            </tr>
        </table>

        <div class="text-center mt-2 mb-4">
            <h1 style="color: @_settings.PrimaryColor; margin: 0; font-size: 28px;">تقرير موقف العهدة والمخزون</h1>
            <hr style="border: 1px solid #333; margin-top: 10px;" />
        </div>

        <MudSimpleTable Style="overflow-x: auto;" Bordered="true" Dense="true" Hover="false" Striped="true" Class="custom-table">
            <thead>
                <tr class="table-header">
                    <th style="@($"background-color: {_settings.PrimaryColor} !important; color: white !important;")">الفئة / التصنيف</th>
                    <th style="@($"background-color: {_settings.PrimaryColor} !important; color: white !important;")">إجمالي الأصناف</th>
                    <th style="@($"background-color: {_settings.PrimaryColor} !important; color: white !important;")">إجمالي العدد</th>
                    <th style="@($"background-color: {_settings.PrimaryColor} !important; color: white !important;")">متاح بالمخزن</th>
                    <th style="@($"background-color: {_settings.PrimaryColor} !important; color: white !important;")">مصروف (عهدة)</th>
                    <th style="@($"background-color: {_settings.PrimaryColor} !important; color: white !important;")">بالصيانة</th>
                    <th style="@($"background-color: {_settings.PrimaryColor} !important; color: white !important;")">كهنة / تالف</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in _reportData)
                {
                    <tr>
                        <td class="font-bold">@item.CategoryName</td>
                        <td>@item.TotalItemsCount</td>
                        <td>@item.TotalAssetsCount</td>
                        <td class="text-success font-bold">@item.AvailableCount</td>
                        <td class="text-info">@item.AssignedCount</td>
                        <td class="text-warning">@item.MaintenanceCount</td>
                        <td class="text-danger">@item.DamagedCount</td>
                    </tr>
                }
                <tr class="table-footer">
                    <td>الإجمالي الكلي</td>
                    <td>@_reportData.Sum(x => x.TotalItemsCount)</td>
                    <td>@_reportData.Sum(x => x.TotalAssetsCount)</td>
                    <td>@_reportData.Sum(x => x.AvailableCount)</td>
                    <td>@_reportData.Sum(x => x.AssignedCount)</td>
                    <td>@_reportData.Sum(x => x.MaintenanceCount)</td>
                    <td>@_reportData.Sum(x => x.DamagedCount)</td>
                </tr>
            </tbody>
        </MudSimpleTable>

        <table style="width: 100%; margin-top: 50px;">
            <tr>
                <td style="text-align: center; width: 33%;">
                    <p style="font-weight: bold;">أمين العهدة</p>
                    <div style="border-bottom: 1px dashed #000; width: 80%; margin: 30px auto 5px;"></div>
                    <p style="font-size: 12px;">الاسم / التوقيع</p>
                </td>
                <td style="text-align: center; width: 33%;">
                    <p style="font-weight: bold;">رئيس الفرع</p>
                    <div style="border-bottom: 1px dashed #000; width: 80%; margin: 30px auto 5px;"></div>
                    <p style="font-size: 12px;">الاسم / التوقيع</p>
                </td>
                <td style="text-align: center; width: 33%;">
                    <p style="font-weight: bold;">قائد الوحدة / المدير</p>
                    <div style="border-bottom: 1px dashed #000; width: 80%; margin: 30px auto 5px;"></div>
                    <p style="font-size: 12px;">الاعتماد</p>
                </td>
            </tr>
        </table>
    </div>
</MudContainer>

@code {
    private List<InventoryReportDto> _reportData = new();
    private SystemSetting _settings = new();

    protected override async Task OnInitializedAsync()
    {
        _settings = await SettingsService.GetSettingsAsync();
        _reportData = await ReportService.GetInventorySummaryAsync();
    }

    private async Task PrintReport()
    {
        await JS.InvokeVoidAsync("printDiv", "printableArea");
    }
}

<style>
    /* تنسيقات بسيطة ونظيفة */
    .report-container {
        background-color: white;
        min-height: 297mm;
        padding: 20px;
    }

    .font-bold {
        font-weight: 800;
    }

    .table-header th {
        font-weight: bold !important;
        border: 1px solid #ccc !important;
        text-align: center !important;
        color: white !important;
    }

    .table-footer td {
        background-color: #e0e0e0 !important;
        font-weight: bold;
        border-top: 2px solid #000;
    }

    .custom-table td {
        text-align: center;
        border: 1px solid #eee;
    }

    /* إعدادات الطباعة */
    @@media print {
        .no-print, .mud-appbar, .mud-drawer {
            display: none !important;
        }

        .mud-layout, .mud-main-content {
            display: block !important;
            padding: 0 !important;
            margin: 0 !important;
            position: static !important;
            overflow: visible !important;
            height: auto !important;
        }

        body {
            background-color: white;
            margin: 0;
        }

        .report-container {
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }
        /* إجبار الألوان */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    }
</style>
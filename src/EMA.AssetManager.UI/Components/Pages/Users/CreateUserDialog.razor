@page "/users/create"
@using EMA.AssetManager.Domain.Enums
@using EMA.AssetManager.Services.Dtos.Users
@using EMA.AssetManager.Services.Interfaces
@inject IUserService UserService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Class="pa-6" Elevation="4">
        <MudText Typo="Typo.h5" Class="mb-6 font-bold text-center">إنشاء حساب ضابط جديد</MudText>

        <MudForm @ref="_form">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField T="string" Label="الاسم بالكامل" @bind-Value="_model.FullName"
                                  Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField T="string" Label="الرتبة" @bind-Value="_model.Rank"
                                  Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField T="string" Label="الرقم العسكري" @bind-Value="_model.MilitaryNumber"
                                  Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField T="string" Label="اسم الدخول (Username)" @bind-Value="_model.UserName"
                                  Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField T="string" Label="كلمة المرور" @bind-Value="_model.Password"
                                  Variant="Variant.Outlined" InputType="InputType.Password" Required="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudSelect T="UserRole" Label="الصلاحية" @bind-Value="_model.Role" Variant="Variant.Outlined">
                        @foreach (UserRole role in Enum.GetValues(typeof(UserRole)))
                        {
                            <MudSelectItem Value="@role">@role.ToString()</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <div class="d-flex align-center justify-space-between mt-8">
                <MudButton Variant="Variant.Text" OnClick="@(() => Navigation.NavigateTo("/users"))">إلغاء</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="HandleSubmit">حفظ البيانات</MudButton>
            </div>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private CreateUserDto _model = new();
    private MudForm _form = default!;

    private async Task HandleSubmit()
    {
        await _form.Validate();
        if (_form.IsValid)
        {
            try
            {
                var result = await UserService.CreateUserAsync(_model);
                if (result)
                {
                    Snackbar.Add("تم إضافة الضابط بنجاح!", Severity.Success);
                    Navigation.NavigateTo("/users");
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }
    }
}